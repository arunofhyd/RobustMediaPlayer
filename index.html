<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="iExbroKtO4ZRq3ZjUsyY8JJowXvx-yHOy4yQq0iS6vY" />
    <title>Robust Media Player</title>
    
    <meta name="description" content="A robust, single-file media player supporting local files, external links, subtitles, and extensive subtitle customization.">
    <meta name="keywords" content="robust player, robust media player, rmp, media player, video player, audio player, local player, local media player, local video player with subs, subtitle customizer, VTT, SRT, local media">
    
    <link rel="icon" href="assets/logo.png" type="image/png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/logo.png">
    <link rel="icon" type="image/png" sizes="16x16" href="assets/logo.png">
    <link rel="shortcut icon" href="assets/logo.png">
    
    <link rel="apple-touch-icon" href="assets/logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="assets/logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="assets/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="assets/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Robust Media Player">
    
    <meta name="application-name" content="Robust Media Player">
    <meta name="msapplication-TileImage" content="assets/logo.png">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="theme-color" id="theme-color-meta" content="#3b82f6">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FONT AWESOME FOR ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJdQkYmB4J7s8pQ/6T+o6H+P45U+k5+8fJg+C6S6" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <link rel="preload" 
          href="https://fonts.googleapis.com/css2?family=Fira+Sans&family=Inter:wght@400;600&family=Lato&family=Montserrat&family=Open+Sans&family=PT+Serif&family=Roboto&family=Source+Sans+Pro&display=swap" 
          as="style" 
          onload="this.onload=null;this.rel='stylesheet'">
    
    <style id="subtitle-style"></style>
    
    <style>
        /* --- CSS Custom Properties for Theming --- */
        :root {
            /* Dark Mode (Default) */
            --bg-primary: #09090b;
            --card-bg: #18181b;
            --card-border: #27272a;
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa; /* gray-400 */
            --input-bg: #3f3f46; /* gray-700 */
            --input-border: #52525b; /* gray-600 */
            --link-color: #60a5fa; /* blue-400 */
            --sub-bg-color: rgba(0, 0, 0, 0.1);
        }

        .light-mode {
            /* Light Mode */
            --bg-primary: #f4f4f5;
            --card-bg: #ffffff;
            --card-border: #e4e4e7;
            --text-primary: #18181b;
            --text-secondary: #71717a;
            --input-bg: #f9f9fb;
            --input-border: #e4e4e7;
            --link-color: #2563eb; /* blue-600 */
            --sub-bg-color: rgba(255, 255, 255, 0.1);
        }

        /* --- Global Styles using Custom Properties --- */
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        /* FIX: Reduce padding for small screens */
        @media (max-width: 639px) { 
            body {
                padding: 0.75rem; /* p-3 equivalent for small screens */
            }
        }
        .container-card {
            background-color: var(--card-bg);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border: 1px solid var(--card-border);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }
        /* FIX: Reduce card padding for phone view (p-4 instead of p-6/p-8) */
        @media (max-width: 639px) { 
            #mainCard {
                padding: 1rem; 
            }
        }
        .text-secondary {
            color: var(--text-secondary);
        }
        .text-link {
            color: var(--link-color);
        }
        .input-style {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
        }
        .status-box {
            background-color: var(--input-bg);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
        }
        
        /* ICON STYLING (FONT AWESOME) */
        .icon {
            transition: color 0.3s;
            color: var(--text-primary);
            line-height: 1; 
        }
        
        /* Header/Theme Toggle button theming for consistency */
        #themeToggle {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* --- Component Specific Styles --- */
        .media-container {
            position: relative;
            /* Ensures 16:9 aspect ratio */
            aspect-ratio: 16 / 9;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
            width: 100%; /* Ensure it always takes full container width */
        }
        .media-container > * {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        .file-input-wrapper input[type="file"] {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 20;
        }
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid transparent;
            font-weight: 600;
        }
        
        /* Primary (Load Link) - Blue stays consistent */
        .btn-primary {
            background-color: #2563eb;
            border-color: #2563eb;
        }
        .btn-primary:hover {
            background-color: #1d4ed8;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
        }
        /* Secondary (Local Media) - Indigo stays consistent */
        .btn-secondary {
            background-color: #4f46e5;
            border-color: #4f46e5;
        }
        .btn-secondary:hover {
            background-color: #4338ca;
            box-shadow: 0 2px 8px rgba(79, 70, 229, 0.4);
        }
        /* Tertiary (Subtitles) - Green stays consistent */
        .btn-tertiary {
            background-color: #10b981;
            border-color: #10b981;
        }
        .btn-tertiary:hover {
            background-color: #059669;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
        }
        
        /* Slider Styling Fix */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            height: 16px;
        }
        input[type="range"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--link-color);
            border-radius: 4px;
        }
        
        /* Webkit (Chrome, Safari, Edge) */
        input[type="range"]::-webkit-slider-runnable-track {
            height: 8px;
            background: var(--input-border); 
            border-radius: 4px;
            border: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--link-color);
            cursor: pointer;
            margin-top: -4px;
            border: 2px solid var(--card-bg);
        }
        
        /* Mozilla (Firefox) */
        input[type="range"]::-moz-range-track {
            height: 8px;
            background: var(--input-border);
            border-radius: 4px;
            border: none;
        }
        input[type="range"]::-moz-range-thumb {
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: var(--link-color);
            cursor: pointer;
            border: 2px solid var(--card-bg);
        }

        /* --- SUBTITLE SETTINGS LAYOUT FIX --- */
        .setting-control {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        #subFontColor, #subFontFamily, #subFontSize, #subOffset, #subBgColor, #subBgOpacity { 
            height: 38px;
            padding: 8px 4px;
        }
        #subFontColor, #subBgColor {
            padding: 2px;
            height: 38px;
        }

    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="app" class="max-w-5xl mx-auto" role="main">
        <header class="text-center mb-6 sm:mb-8 flex items-center justify-between">
            <div class="flex-grow text-left sm:text-center">
                <div class="inline-flex items-center justify-start sm:justify-center">
                    <img src="assets/logo.png" 
                                 alt="Robust Media Player Logo" 
                                 class="h-6 w-6 sm:h-8 sm:w-8 mr-2 sm:mr-3" 
                                 aria-hidden="true" 
                                 onerror="this.style.display='none'">
                    <h1 class="text-2xl sm:text-4xl font-extrabold text-link">Robust Media Player</h1>
                </div>
                <p class="mt-1 sm:mt-2 text-sm text-secondary">Load direct video/audio files or use external embeds.</p>
            </div>
            
            <button id="themeToggle" 
                    class="w-10 h-10 sm:w-12 sm:h-12 flex items-center justify-center rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex-shrink-0"
                    aria-label="Toggle Dark/Light Mode"
                    title="Toggle Dark/Light Mode">
                <!-- FONT AWESOME ICONS -->
                <i id="moonIcon" class="icon fa-solid fa-moon text-xl" aria-hidden="true"></i>
                <i id="sunIcon" class="icon fa-solid fa-sun text-xl hidden" aria-hidden="true"></i>
            </button>
        </header>

        <div id="mainCard" class="container-card p-4 sm:p-8 rounded-xl relative">
            
            <div id="alertBox" class="hidden p-3 rounded-lg text-xs sm:text-sm mb-4 sm:mb-6 shadow-xl flex items-center" role="alert" aria-live="assertive">
                <div class="flex items-center">
                    <svg id="alertIcon" class="w-4 h-4 sm:w-5 sm:h-5 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    <span id="alertText" class="font-medium"></span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4 mb-4 sm:mb-6" role="group" aria-labelledby="control-group-label">
                <h2 id="control-group-label" class="sr-only">Media Loading Controls</h2>
                
                <div class="md:col-span-2">
                    <label for="videoUrl" class="block text-xs sm:text-sm font-medium text-secondary mb-1">Video/Embed URL</label>
                    <div class="flex" role="search">
                        <input type="text" id="videoUrl" placeholder="Enter link, e.g., https://streamtape.com/e/ or direct mp4/mp3 link"
                               class="flex-grow p-2.5 sm:p-3 border rounded-l-lg input-style focus:ring-blue-500 focus:border-blue-500 outline-none"
                               aria-label="Media or Embed URL Input">
                        <button id="loadUrlBtn" 
                                class="btn btn-primary px-3 sm:px-4 py-2.5 sm:py-3 text-white rounded-r-lg flex-shrink-0 flex items-center justify-center"
                                aria-label="Load Media or Embed Link">
                            <span class="hidden sm:inline">Load Link</span>
                            <!-- Icon for mobile -->
                            <i class="fa-solid fa-arrow-right sm:hidden text-lg"></i>
                        </button>
                    </div>
                </div>

                <div class="file-input-wrapper relative overflow-hidden inline-block w-full">
                    <button class="btn btn-secondary w-full text-white py-2.5 sm:py-3 rounded-lg shadow-md flex flex-col justify-center items-center"
                            aria-hidden="true" tabindex="-1">
                        <div class="text-sm sm:text-base">Load Local Media File</div>
                        <span class="text-[10px] sm:text-xs font-normal text-indigo-300 opacity-80 mt-1">Video (.mp4, .webm, .mkv, .avi, .mov) & Audio (.mp3, .wav, .flac)</span>
                    </button>
                    <input type="file" id="videoFile" accept="video/*,audio/*" class="absolute inset-0 block"
                            aria-label="Select local video or audio file to load">
                </div>

                <div class="relative w-full">
                    <div class="grid grid-cols-5">
                        <div class="file-input-wrapper relative overflow-hidden inline-block col-span-4">
                            <button class="btn btn-tertiary w-full text-white py-2.5 sm:py-3 rounded-l-lg shadow-md flex flex-col justify-center items-center h-full"
                                     aria-hidden="true" tabindex="-1">
                                <div class="text-sm sm:text-base">Load Local Subtitle</div>
                                <span class="text-[10px] sm:text-xs font-normal text-green-300 opacity-80 mt-1">Subtitles (.vtt, .srt)</span>
                            </button>
                            <input type="file" id="subtitleFile" accept=".vtt,.srt" class="absolute inset-0 block"
                                     aria-label="Select local subtitle file (VTT or SRT) to load">
                        </div>
                        <button id="subSettingsToggle" 
                                    class="btn btn-tertiary text-white py-2.5 sm:py-3 rounded-r-lg shadow-md flex items-center justify-center flex-shrink-0"
                                    aria-label="Toggle Subtitle Appearance Settings"
                                    aria-controls="subSettingsPanel"
                                    aria-expanded="false">
                            <!-- FONT AWESOME SETTINGS ICON -->
                            <i class="fa-solid fa-gear text-lg" style="color: white; transform: rotate(0deg); transition: transform 0.3s;" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="subSettingsPanel" class="mb-4 sm:mb-6 hidden border border-card-border shadow-md rounded-xl bg-card-bg" 
                 role="region" aria-labelledby="sub-settings-heading">
                <div id="subSettingsContent" class="p-3 sm:p-4">
                    <h3 id="sub-settings-heading" class="text-base sm:text-lg font-semibold text-link mb-3">Subtitle Appearance Settings</h3>
                    
                    <!-- Updated grid to better accommodate 5 smaller controls -->
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-3 sm:gap-4 text-xs sm:text-sm">
                        
                        <div class="setting-control">
                            <label for="subFontColor" class="text-secondary">Font Color</label>
                            <input type="color" id="subFontColor" class="w-full border rounded input-style cursor-pointer" value="#ffffff"
                                     aria-label="Subtitle Font Color Picker">
                        </div>
                        
                        <div class="setting-control">
                            <label for="subFontFamily" class="text-secondary">Font Family</label>
                            <select id="subFontFamily" class="w-full border rounded input-style"
                                     aria-label="Subtitle Font Family Selector">
                                <option value="'Inter', sans-serif">Inter (Default)</option>
                                <option value="'Roboto', sans-serif">Roboto (Clean Sans)</option>
                                <option value="'Open Sans', sans-serif">Open Sans (Open, Legible)</option>
                                <option value="'Lato', sans-serif">Lato (High Contrast)</option>
                                <option value="'Montserrat', sans-serif">Montserrat (Modern)</option>
                                <option value="'Source Sans Pro', sans-serif">Source Sans Pro (Geometric)</option>
                                <option value="'PT Serif', serif">PT Serif (Classic Serif)</option>
                                <option value="'Fira Sans', sans-serif">Fira Sans (Accessibility)</option>
                                <option value="'Courier New', monospace">Courier New (Monospace)</option>
                            </select>
                        </div>

                        <div class="setting-control">
                            <label for="subFontSize" class="text-secondary">Font Size (<span id="currentFontSize">24px</span>)</label>
                            <input type="range" id="subFontSize" min="2" max="100" value="24" step="1"
                                     class="w-full cursor-pointer"
                                     aria-label="Subtitle Font Size Slider, minimum 2 pixels, maximum 100 pixels">
                        </div>

                        <!-- Subtitle Background Color Control -->
                        <div class="setting-control">
                            <label for="subBgColor" class="text-secondary">BG Color</label>
                            <input type="color" id="subBgColor" class="w-full border rounded input-style cursor-pointer" value="#000000"
                                     aria-label="Subtitle Background Color Picker">
                        </div>
                        
                        <!-- Subtitle Background Opacity Control (Default changed to 50%) -->
                        <div class="setting-control">
                            <label for="subBgOpacity" class="text-secondary">BG Opacity (<span id="currentBgOpacity">50%</span>)</label>
                            <input type="range" id="subBgOpacity" min="0" max="100" value="50" step="5"
                                    class="w-full cursor-pointer"
                                    aria-label="Subtitle Background Opacity Slider">
                        </div>
                        
                        <!-- Placeholder to ensure layout stability -->
                        <div class="hidden sm:block"></div> 
                        
                    </div>

                    <!-- Existing Subtitle Offset Control - separated visually -->
                    <div class="setting-control mt-4 border-t border-card-border pt-4">
                        <label for="subOffset" class="text-secondary">Subtitle Offset (Seconds: <span id="currentSubOffset">0.0</span>s)</label>
                        <!-- Range from -10 to +10 seconds, step 0.1 -->
                        <input type="range" id="subOffset" min="-10" max="10" value="0.0" step="0.1"
                                class="w-full cursor-pointer"
                                aria-label="Subtitle Timing Offset Slider, from -10 to +10 seconds">
                    </div>

                </div>
            </div>


            <div class="media-container rounded-xl shadow-2xl" role="region" aria-label="Media Player and Subtitle Preview Area">
                <div id="subtitleDemo" class="absolute z-50 bottom-4 sm:bottom-8 left-1/2 transform -translate-x-1/2 p-2 pointer-events-none transition-all duration-300 ease-in-out text-center hidden max-w-full"
                              aria-live="polite" aria-atomic="true">
                    <span id="demoText" style="white-space: nowrap; padding: 6px 12px; border-radius: 6px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">The quick brown fox jumps over the lazy dog</span>
                </div>

                <div id="dragDropOverlay" class="absolute inset-0 z-10 hidden flex-col items-center justify-center 
                                                 bg-gray-900/90 border-4 border-dashed border-blue-500 rounded-xl transition duration-150 ease-in-out pointer-events-none"
                                                 aria-hidden="true">
                    <p class="text-xl sm:text-3xl text-blue-300 font-bold mb-2">Drop File Here</p>
                    <p class="text-sm sm:text-lg text-gray-400">(Video, Audio, .VTT, or .SRT)</p>
                </div>
                
                <video id="videoPlayer" controls preload="auto" poster="https://placehold.co/800x450/1f2937/a0aec0?text=Ready+to+Load+Media"
                                 aria-label="HTML5 Video Player for local media">
                    </video>
                
                <iframe id="iframePlayer" style="display: none;" 
                                 allowfullscreen allowtransparency allow="autoplay" scrolling="no" frameborder="0"
                                 aria-label="External Video Embed Player">
                </iframe>
            </div>

            <div id="statusMessage" class="mt-4 text-center text-xs sm:text-sm p-3 rounded-lg status-box" role="status" aria-live="polite">
                Ready to load content. Drag and drop a file onto the player area above!
            </div>

        </div>
    </div>

    <script>
        // Setup Firestore global variables (even if not used, they must be initialized if present)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // --- Core Application Logic ---
        
        const videoPlayer = document.getElementById('videoPlayer');
        const iframePlayer = document.getElementById('iframePlayer');
        const videoUrlInput = document.getElementById('videoUrl');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const videoFileInput = document.getElementById('videoFile');
        const subtitleFileInput = document.getElementById('subtitleFile');
        const statusMessage = document.getElementById('statusMessage');
        const mainCard = document.getElementById('mainCard'); // Main drag target
        const dragDropOverlay = document.getElementById('dragDropOverlay');
        const themeToggle = document.getElementById('themeToggle');
        
        // Updated to target the new Font Awesome <i> tags
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        
        const subtitleStyleSheet = document.getElementById('subtitle-style');
        
        // Subtitle customization DOM elements
        const subSettingsToggle = document.getElementById('subSettingsToggle'); // Now the gear button
        const subSettingsPanel = document.getElementById('subSettingsPanel');
        
        // Demo elements
        const subtitleDemo = document.getElementById('subtitleDemo');
        const demoText = document.getElementById('demoText');
        
        // Input elements
        const subFontColorInput = document.getElementById('subFontColor');
        const subFontSizeInput = document.getElementById('subFontSize');
        const subFontFamilyInput = document.getElementById('subFontFamily');
        const subOffsetInput = document.getElementById('subOffset');
        const subBgColorInput = document.getElementById('subBgColor'); 
        const subBgOpacityInput = document.getElementById('subBgOpacity'); 
        
        // New element to display current size and offset
        const currentFontSizeSpan = document.getElementById('currentFontSize');
        const currentSubOffsetSpan = document.getElementById('currentSubOffset');
        const currentBgOpacitySpan = document.getElementById('currentBgOpacity'); 


        // --- State Management ---
        let alertTimeout;
        let currentVideoBlobUrl = null; // Track the current video's blob URL for revocation

        // Global variable to store the original cues when a subtitle file is loaded
        let originalCues = [];
        let activeTrack = null; // Reference to the currently active TextTrack

        /**
         * Helper function to convert hex color to RGBA format.
         */
        function hexToRgba(hex, alpha) {
            // Remove the # if it exists
            const shortHex = hex.startsWith('#') ? hex.slice(1) : hex;

            // Handle 3-digit hex by duplicating each character (e.g., f0a -> ff00aa)
            const standardHex = shortHex.length === 3
                ? shortHex.split('').map(char => char + char).join('')
                : shortHex;

            const r = parseInt(standardHex.slice(0, 2), 16);
            const g = parseInt(standardHex.slice(2, 4), 16);
            const b = parseInt(standardHex.slice(4, 6), 16);

            // Ensure alpha is a number and clamped between 0 and 1
            const finalAlpha = Math.max(0, Math.min(1, parseFloat(alpha)));
            
            return `rgba(${r}, ${g}, ${b}, ${finalAlpha})`;
        }

        // --- Theme Toggle Logic (unchanged) ---
        
        /**
         * Sets the current theme mode (light or dark).
         * @param {string} theme - 'light' or 'dark'.
         */
        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                // Use Font Awesome icons with the same toggling logic
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.remove('light-mode');
                // Use Font Awesome icons with the same toggling logic
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            }
        }

        themeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('light-mode')) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        });

        // Initialize theme on load
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme) {
            setTheme(storedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
            // Default to system light preference if no storage exists
            setTheme('light');
        } else {
            setTheme('dark');
        }

        // --- Subtitle Styling and Offset Logic ---

        const SUB_SETTINGS_KEY = 'subtitleSettings';

        /**
         * Loads saved subtitle settings from localStorage and applies them to inputs.
         */
        function loadSubtitleSettings() {
            const savedSettings = localStorage.getItem(SUB_SETTINGS_KEY);
            const defaultSettings = {
                fontColor: '#ffffff',
                fontSize: '24px', 
                fontFamily: "'Inter', sans-serif",
                subOffset: 0.0,
                bgColor: '#000000', 
                bgOpacity: 50 // DEFAULT CHANGED TO 50
            };

            const settings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;

            // Apply settings to controls
            subFontColorInput.value = settings.fontColor;
            
            // Set slider values, clamping as needed
            const sizeInPixels = parseInt(settings.fontSize.replace('px', '')) || 24;
            subFontSizeInput.value = Math.max(2, Math.min(100, sizeInPixels)); 
            
            subOffsetInput.value = parseFloat(settings.subOffset) || 0.0;
            
            subBgColorInput.value = settings.bgColor; 
            subBgOpacityInput.value = parseInt(settings.bgOpacity) || 50; // FALLBACK CHANGED TO 50

            subFontFamilyInput.value = settings.fontFamily;
            
            // Apply styles and offset immediately
            applySubtitleStyles();
            applySubtitleOffset();
            
            // Set initial demo text
            demoText.textContent = "The quick brown fox jumps over the lazy dog";
        }

        /**
         * Reads current input values, saves them, and updates the ::cue CSS rule AND the live demo.
         */
        function applySubtitleStyles() {
            // Read raw value (number string from slider)
            const rawFontSize = subFontSizeInput.value; 
            const rawOffset = parseFloat(subOffsetInput.value).toFixed(1); 
            
            // NEW BG reads and RGBA calculation
            const rawBgColor = subBgColorInput.value;
            const rawBgOpacity = subBgOpacityInput.value;
            const alpha = rawBgOpacity / 100; // Convert 0-100 range to 0-1 alpha
            const cueBgColor = hexToRgba(rawBgColor, alpha);

            const settings = {
                fontColor: subFontColorInput.value,
                fontSize: rawFontSize + 'px', 
                fontFamily: subFontFamilyInput.value,
                subOffset: rawOffset,
                bgColor: rawBgColor, // Save BG Color
                bgOpacity: rawBgOpacity // Save BG Opacity (as 0-100)
            };
            
            // Update the visual display next to the labels
            if(currentFontSizeSpan) {
                currentFontSizeSpan.textContent = settings.fontSize;
            }
            if(currentSubOffsetSpan) {
                currentSubOffsetSpan.textContent = rawOffset;
            }
            if(currentBgOpacitySpan) {
                currentBgOpacitySpan.textContent = rawBgOpacity + '%'; // NEW
            }

            // Save to localStorage for persistence
            localStorage.setItem(SUB_SETTINGS_KEY, JSON.stringify(settings));

            
            // --- 1. Apply to actual ::cue element (via dynamic style tag) ---
            const cssRule = `
                video::cue {
                    color: ${settings.fontColor} !important;
                    background-color: ${cueBgColor} !important; /* USE CALCULATED RGBA */
                    font-size: ${settings.fontSize} !important;
                    font-family: ${settings.fontFamily} !important;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8); 
                }
            `;
            subtitleStyleSheet.textContent = cssRule;

            // --- 2. Apply to LIVE DEMO overlay (uses vw units for proportionality) ---
            // Calculate proportional demo size
            const proportionalSize = (parseInt(rawFontSize) / 100) * 5; 
            const demoFontSize = Math.max(0.5, Math.min(6.0, proportionalSize)); 
            
            demoText.style.color = settings.fontColor;
            demoText.style.backgroundColor = cueBgColor; // Use calculated RGBA
            demoText.style.fontSize = demoFontSize + 'vw'; /* Use VW for proportional sizing */
            demoText.style.fontFamily = settings.fontFamily;
            demoText.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.8)';
            demoText.style.display = 'inline-block'; // FIX 1: Ensures the background color is visible
            
            // 3. Apply the time offset if a track is active
            applySubtitleOffset();
        }

        /**
         * Applies the time offset to the currently active subtitle track cues.
         */
        function applySubtitleOffset() {
            const offset = parseFloat(subOffsetInput.value);
            currentSubOffsetSpan.textContent = offset.toFixed(1);

            // Find the active track
            const tracks = videoPlayer.textTracks;
            let currentTrack = null;

            for (let i = 0; i < tracks.length; i++) {
                if (tracks[i].mode === 'showing' || tracks[i].default) {
                    currentTrack = tracks[i];
                    break;
                }
            }

            if (!currentTrack) return;

            // If the active track changed, or if cues haven't been stored, store them (only runs once per file load)
            if (currentTrack !== activeTrack || originalCues.length === 0) {
                 // Wait for the track cues to be loaded (can take a moment for large files)
                if (currentTrack.cues && currentTrack.cues.length > 0) {
                    originalCues = Array.from(currentTrack.cues).map(cue => ({
                        start: cue.startTime,
                        end: cue.endTime,
                        text: cue.text
                    }));
                    activeTrack = currentTrack;
                } else {
                    // Try again when cues are ready (e.g., if loaded over network)
                    currentTrack.addEventListener('load', applySubtitleOffset, { once: true });
                    return;
                }
            }

            // Clear existing cues
            while(currentTrack.cues.length > 0) {
                currentTrack.removeCue(currentTrack.cues[0]);
            }
            
            // Re-add cues with the new offset
            originalCues.forEach(cueData => {
                const newStartTime = Math.max(0, cueData.start + offset);
                const newEndTime = Math.max(newStartTime, cueData.end + offset);

                const newCue = new VTTCue(newStartTime, newEndTime, cueData.text);
                // Inherit alignment properties if available (though many are lost converting to VTT)
                currentTrack.addCue(newCue);
            });
            
            // This is crucial: the track needs to be showing for the cues to appear
            currentTrack.mode = 'showing';
        }


        // Attach event listeners to all controls for real-time feedback
        [subFontColorInput, subFontFamilyInput, subFontSizeInput, subOffsetInput, subBgColorInput, subBgOpacityInput].forEach(input => {
            // Use 'input' for sliders for smooth drag feedback, 'change' for selects/colors
            const eventType = input.type === 'range' ? 'input' : 'change';
            input.addEventListener(eventType, applySubtitleStyles);
        });
        
        // --- Collapsible Logic ---
        
        /**
         * Toggles the visibility of the subtitle settings panel and updates the icon.
         */
        function toggleSubSettings() {
            const isHidden = subSettingsPanel.classList.toggle('hidden');
            const gearIcon = subSettingsToggle.querySelector('i'); // Target the Font Awesome <i> tag

            // FIX 2: Only hide the demo if the panel is closed.
            subtitleDemo.classList.toggle('hidden', isHidden);
            
            // Update the gear icon rotation (Subtle 180-degree flip)
            gearIcon.style.transform = isHidden ? '' : 'rotate(180deg)';
            
            // Update ARIA attribute for screen readers
            subSettingsToggle.setAttribute('aria-expanded', !isHidden);

            // Adjust main card corner rounding to visually connect/disconnect the panel
            if (isHidden) {
                // When panel is hidden, main card should be fully rounded
                mainCard.classList.add('rounded-xl');
                mainCard.classList.remove('rounded-b-none');
            } else {
                // When panel is visible, main card should lose its bottom rounding
                mainCard.classList.remove('rounded-xl');
                mainCard.classList.add('rounded-b-none');
                // Ensure the new panel is rounded at the bottom when visible
                subSettingsPanel.classList.remove('rounded-xl');
                subSettingsPanel.classList.add('rounded-b-xl');
            }
        }

        // Add event listener to the new gear icon toggle
        subSettingsToggle.addEventListener('click', toggleSubSettings);


        // --- Utility Functions (unchanged) ---

        /**
         * Displays a temporary, visually distinct alert message for errors/warnings/successes.
         */
        function showTemporaryAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            const alertText = document.getElementById('alertText');
            const alertIcon = document.getElementById('alertIcon');

            if (alertTimeout) {
                clearTimeout(alertTimeout);
            }

            // Reset classes
            alertBox.className = "hidden p-3 rounded-lg text-xs sm:text-sm mb-4 sm:mb-6 shadow-xl flex items-center";
            alertIcon.innerHTML = ''; // Clear icon content
            alertBox.classList.remove('bg-red-900', 'text-red-300', 'border-red-700', 'bg-yellow-900', 'text-yellow-300', 'border-yellow-700', 'bg-green-900', 'text-green-300', 'border-green-700');

            if (type === 'error') {
                // Red for critical failure
                alertBox.classList.add('bg-red-900', 'text-red-300', 'border', 'border-red-700');
                // Error icon
                alertIcon.innerHTML = `<path fill-rule="evenodd" d="M8.257 3.376a1.5 1.5 0 012.486 0l5.5 10A1.5 1.5 0 0115 15.75H5a1.5 1.5 0 01-1.243-2.374l5.5-10zM12 9a1 1 0 11-2 0 1 1 0 012 0zm-1 2a1 1 0 10-2 0v2a1 1 0 102 0v-2z" clip-rule="evenodd" />`;
            } else if (type === 'warning') {
                // Yellow/Orange for non-critical warnings
                alertBox.classList.add('bg-yellow-900', 'text-yellow-300', 'border', 'border-yellow-700');
                // Warning icon
                alertIcon.innerHTML = `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>`;
            } else if (type === 'success') {
                // Green for success messages
                alertBox.classList.add('bg-green-900', 'text-green-300', 'border', 'border-green-700');
                // Checkmark icon
                alertIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.644-1.897-1.898a.75.75 0 10-1.06 1.06l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />`; 
            }

            alertText.textContent = message;
            alertBox.classList.remove('hidden');

            alertTimeout = setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 8000);
        }

        /**
         * Clears existing subtitle tracks from the video element and resets state.
         */
        function clearTracks() {
            const tracks = videoPlayer.querySelectorAll('track');
            tracks.forEach(track => {
                if (track.src.startsWith('blob:')) {
                    URL.revokeObjectURL(track.src);
                }
                track.remove();
            });
            originalCues = [];
            activeTrack = null;
        }
        
        /**
         * Switches the display mode to either HTML5 Video or Iframe Embed.
         * @param {string} mode - 'video' or 'iframe'.
         */
        function setPlayerMode(mode) {
            if (mode === 'video') {
                videoPlayer.style.display = 'block';
                iframePlayer.style.display = 'none';
                iframePlayer.src = ''; 
                // Enable drag drop overlay only for HTML5 video mode
                dragDropOverlay.classList.remove('pointer-events-none'); 
            } else if (mode === 'iframe') {
                videoPlayer.style.display = 'none';
                videoPlayer.src = ''; 
                videoPlayer.poster = 'https://placehold.co/800x450/1f2937/a0aec0?text=External+Embed+Loaded';
                clearTracks();
                iframePlayer.style.display = 'block';
                // Disable drag drop overlay in iframe mode as subs won't work
                dragDropOverlay.classList.add('pointer-events-none');
                
                // Clear media download state for external embeds
                if (currentVideoBlobUrl) {
                    URL.revokeObjectURL(currentVideoBlobUrl);
                }
                currentVideoBlobUrl = null;
            }
            // Hide the subtitle demo when player mode changes or media is active
            if (subtitleDemo.classList.contains('hidden')) {
                // If it was already hidden (settings closed), keep it hidden
            } else {
                subtitleDemo.classList.add('hidden');
            }
        }

        /**
         * Converts SRT format text to VTT format text.
         */
        function srtToVtt(srtText) {
            // Replace all comma delimiters (used by SRT for milliseconds) with periods (used by VTT)
            const vttBody = srtText.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
            return 'WEBVTT\n\n' + vttBody;
        }

        /**
         * Updates the media source and switches between HTML5 Video and Iframe.
         * @param {string} src - The new media source URL.
         * @param {string | null} fileName - The filename if loaded from disk.
         */
        function loadMediaSource(src, fileName = null) {
            src = src ? src.trim() : '';

            // Handle clearing source
            if (!src) {
                if (currentVideoBlobUrl) {
                    URL.revokeObjectURL(currentVideoBlobUrl);
                }
                setPlayerMode('video');
                videoPlayer.src = '';
                videoPlayer.poster = 'https://placehold.co/800x450/1f2937/a0aec0?text=No+Media+Loaded';
                statusMessage.textContent = 'Media source cleared.';
                videoPlayer.load();
                return;
            }

            const isBlobUrl = src.startsWith('blob:');
            const mediaExtensions = /\.(mp4|webm|ogg|mov|avi|m4v|flv|f4v|mkv|wmv|ts|mp3|wav|flac|m4a)$/i;
            const urlWithoutQuery = src.split('?')[0];
            
            const isDirectMediaFile = mediaExtensions.test(urlWithoutQuery) || isBlobUrl; 
            const isExternalLink = src.startsWith('http://') || src.startsWith('https://');

            if (isDirectMediaFile) {
                // Mode 1: HTML5 Video/Audio (Supports Subtitles - local VTT/SRT files via Blob)
                setPlayerMode('video');
                
                // --- Memory Management: Revoke old Blob URL ---
                if (currentVideoBlobUrl && currentVideoBlobUrl !== src && currentVideoBlobUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(currentVideoBlobUrl);
                }

                // If the new source is a blob URL, track it
                if (isBlobUrl) {
                    currentVideoBlobUrl = src;
                } else {
                    currentVideoBlobUrl = null;
                }
                
                videoPlayer.removeAttribute('src'); 
                videoPlayer.src = src; 
                videoPlayer.load();
                
                videoPlayer.poster = '';
                const sourceType = isBlobUrl ? 'Local File (Drag & Drop)' : 'Direct Link';
                const mediaType = src.match(/\.(mp3|wav|flac|m4a)$/i) ? 'Audio' : 'Video';

                statusMessage.textContent = `${sourceType} (${mediaType}) loaded. Local subtitle loading is supported.`;
                showTemporaryAlert(`Successfully switched to HTML5 ${mediaType} Mode. Source Type: ${sourceType}`, 'success');
            } else if (isExternalLink) {
                // Revoke any previous local video URL
                if (currentVideoBlobUrl) {
                    URL.revokeObjectURL(currentVideoBlobUrl);
                }
                currentVideoBlobUrl = null;
                
                // Mode 2: Iframe Embed (Does NOT support local Subtitles)
                setPlayerMode('iframe');
                iframePlayer.src = src;
                statusMessage.innerHTML = 'External embed loaded via Iframe. <span class="text-red-400 font-bold">Local subtitle loading is NOT supported.</span>';
                showTemporaryAlert('Warning: External embed loaded. Subtitles are unavailable due to cross-domain security.', 'warning');
            } else {
                setPlayerMode('video');
                videoPlayer.src = '';
                videoPlayer.poster = 'https://placehold.co/800x450/cc3333/ffffff?text=Invalid+Input';
                videoPlayer.load();
                statusMessage.textContent = 'Error: Unrecognized link format or insecure protocol.';
                showTemporaryAlert('Error: Unrecognized link format. Please check your URL input.', 'error');
            }
        }

        /**
         * Processes a subtitle file (VTT or SRT) and attaches it to the video player.
         * @param {File} file - The subtitle file object.
         */
        function processSubtitleFile(file) {
             if (videoPlayer.style.display === 'none' || !videoPlayer.src) {
                 showTemporaryAlert('Error: Load a media file in HTML5 Player Mode first.', 'error');
                 subtitleFileInput.value = null; 
                 return;
            }

            const fileName = file.name.toLowerCase();
            let mimeType = 'text/vtt';
            let fileType = '';
            
            if (fileName.endsWith('.vtt')) {
                fileType = 'WebVTT (.vtt)';
            } else if (fileName.endsWith('.srt')) {
                fileType = 'SubRip (.srt)';
            } else {
                showTemporaryAlert('Error: Unsupported subtitle file type. Only .vtt and .srt are accepted.', 'error');
                subtitleFileInput.value = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                let textContent = e.target.result;

                try {
                    if (fileType === 'SubRip (.srt)') {
                        textContent = srtToVtt(textContent);
                        statusMessage.textContent = `Converting ${fileType} to VTT...`;
                    }

                    const subtitleBlob = new Blob([textContent], { type: mimeType });
                    const subtitleUrl = URL.createObjectURL(subtitleBlob);

                    // Clear previous subtitle state
                    clearTracks(); 

                    const track = document.createElement('track');
                    track.kind = 'subtitles';
                    track.label = `Local Subs (${fileType})`;
                    track.srclang = 'en';
                    track.src = subtitleUrl;
                    track.default = true; // This is crucial for initial activation

                    // Must append to the player *before* trying to read cues, to load the VTT
                    videoPlayer.appendChild(track);
                    
                    // Crucial step: wait for the track to load before attempting offset/cues read
                    track.addEventListener('load', () => {
                        statusMessage.textContent = `Subtitle file "${file.name}" loaded and attached.`;
                        showTemporaryAlert(`Subtitle file "${file.name}" loaded successfully. Use the offset slider to sync.`, 'success');
                        
                        // Set the active track and apply the initial offset
                        activeTrack = track.track;
                        applySubtitleOffset(); 
                    }, { once: true });
                    
                    track.track.addEventListener('error', () => {
                        statusMessage.textContent = `CRITICAL ERROR: Failed to load subtitle track (check file format validity).`;
                        showTemporaryAlert('CRITICAL ERROR: Subtitle file could not be parsed by the browser.', 'error');
                    });

                } catch (error) {
                    console.error('Subtitle processing error:', error);
                    statusMessage.textContent = `An error occurred while processing the subtitle file.`;
                    showTemporaryAlert('An error occurred while processing the subtitle file.', 'error');
                }
                subtitleFileInput.value = null; 
            };
            reader.onerror = (error) => {
                console.error('FileReader error:', error);
                statusMessage.textContent = 'Error reading the subtitle file from the disk.';
                showTemporaryAlert('Error reading the subtitle file from the disk.', 'error');
            };

            reader.readAsText(file);
        }

        // --- Event Listeners and Initialization (unchanged) ---
        
        // Listener for the "Load URL" button.
        loadUrlBtn.addEventListener('click', () => {
            const url = videoUrlInput.value.trim();
            loadMediaSource(url);
            videoFileInput.value = '';
        });

        // Listener for local video file input.
        videoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const fileUrl = URL.createObjectURL(file);
                // Pass the filename for memory management
                loadMediaSource(fileUrl, file.name); 
                videoUrlInput.value = '';
            }
        });

        // Listener for local subtitle file input.
        subtitleFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                processSubtitleFile(file);
            }
        });

        // Initial setup for the poster image on error/no source
        videoPlayer.addEventListener('error', () => {
            statusMessage.textContent = 'Error loading video source. Check URL or file format.';
            videoPlayer.poster = 'https://placehold.co/800x450/cc3333/ffffff?text=Media+Loading+Failed';
            showTemporaryAlert('Media failed to load. Check URL or file type.', 'error');
        });

        // --- Drag and Drop Logic (unchanged) ---

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            mainCard.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        mainCard.addEventListener('dragenter', (e) => {
            // Check if the event contains files and if we are in HTML5 player mode
            if (videoPlayer.style.display !== 'none' && e.dataTransfer.types.includes('Files')) {
                 dragDropOverlay.style.display = 'flex';
            }
        }, false);
        
        mainCard.addEventListener('dragleave', (e) => {
            // Only hide if the mouse is leaving the main card completely
            if (!mainCard.contains(e.relatedTarget)) {
                dragDropOverlay.style.display = 'none';
            }
        }, false);

        mainCard.addEventListener('drop', (e) => {
            dragDropOverlay.style.display = 'none';
            const files = e.dataTransfer.files;

            if (files.length === 0) return;

            const file = files[0];
            const fileName = file.name.toLowerCase();

            const isVideo = file.type.startsWith('video/') || fileName.match(/\.(mp4|webm|mkv|avi|mov|ts|wmv)$/i);
            const isAudio = file.type.startsWith('audio/') || fileName.match(/\.(mp3|wav|flac|m4a)$/i);
            const isSubtitle = fileName.endsWith('.vtt') || fileName.endsWith('.srt');

            if (isVideo || isAudio) {
                const fileUrl = URL.createObjectURL(file);
                loadMediaSource(fileUrl, file.name); // Pass filename
                videoUrlInput.value = '';
            } else if (isSubtitle) {
                processSubtitleFile(file);
            } else {
                showTemporaryAlert('Dropped file is neither a supported media nor a subtitle file. Supported: Video, Audio, .vtt, .srt', 'error');
            }
        }, false);
        
        // Add keyboard shortcut for basic media control (Space to Play/Pause)
        document.addEventListener('keydown', (e) => {
            // Check if the active element is NOT the URL input to prevent accidental playback toggles while typing
            if (e.code === 'Space' && document.activeElement !== videoUrlInput && videoPlayer.style.display !== 'none') {
                e.preventDefault();
                if (videoPlayer.paused) {
                    videoPlayer.play();
                } else {
                    videoPlayer.pause();
                }
            }
        });
        
        // --- Final Setup (unchanged) ---
        // Initialize subtitle settings and theme on page load
        loadSubtitleSettings();
        setPlayerMode('video');

    </script>
</body>
</html>
