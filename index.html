<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="google-site-verification" content="iExbroKtO4ZRq3ZjUsyY8JJowXvx-yHOy4yQq0iS6vY" />
    <title>Robust Media Player</title>

    <meta name="description" content="A robust, single-file media player supporting local files, external links, subtitles, and extensive subtitle customization.">
    <meta name="keywords" content="robust player, robust media player, rmp, media player, video player, audio player, local player, local media player, local video player with subs, subtitle customizer, VTT, SRT, local media">

    <link rel="icon" href="/assets/logo.png" sizes="any" type="image/png">
    <link rel="apple-touch-icon" href="/assets/logo.png">
    <link rel="apple-touch-icon" sizes="76x76" href="/assets/logo.png">
    <link rel="apple-touch-icon" sizes="120x120" href="/assets/logo.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/assets/logo.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/logo.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Robust Media Player">

    <meta name="application-name" content="Robust Media Player">
    <meta name="msapplication-TileImage" content="/assets/logo.png">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="theme-color" id="theme-color-meta" content="#3b82f6">
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Organization",
      "url": "https://robustplayer.vercel.app/",
      "logo": "https://robustplayer.vercel.app/assets/logo.png"
    }
    </script>

    <!-- FONT AWESOME FOR ICONS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" xintegrity="sha512-SnH5WK+bZxgPHs44uWIX+LLMDJdQkYmB4J7s8pQ/6T+o6H+P45U+k5+8fJg+C6S6" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="preload"
          href="https://fonts.googleapis.com/css2?family=Fira+Sans&family=Inter:wght@400;500;600;700&family=Lato&family=Montserrat&family=Open+Sans&family=PT+Serif&family=Roboto&family=Source+Sans+Pro&display=swap"
          as="style"
          onload="this.onload=null;this.rel='stylesheet'">

    <style id="subtitle-style"></style>

    <style>
        /* --- CSS Custom Properties for Theming --- */
        :root {
            /* Dark Mode (Default) */
            --bg-primary: #0a0a0f;
            --bg-gradient: linear-gradient(135deg, #0a0a0f 0%, #1a1a2e 100%);
            --card-bg: #16162a;
            --card-bg-elevated: #1e1e38;
            --card-border: #2a2a45;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b8;
            --text-tertiary: #707088;
            --input-bg: #252540;
            --input-bg-hover: #2d2d50;
            --input-border: #3a3a58;
            --input-border-focus: #4a5aff;
            --link-color: #6b7aff;
            --link-hover: #8593ff;
            --sub-bg-color: rgba(0, 0, 0, 0.1);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.25);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.35);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.45);
            --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.55);
        }

        .light-mode {
            /* Light Mode */
            --bg-primary: #f8f9fc;
            --bg-gradient: linear-gradient(135deg, #f8f9fc 0%, #eef1f8 100%);
            --card-bg: #ffffff;
            --card-bg-elevated: #fafbff;
            --card-border: #e0e4f0;
            --text-primary: #1a1a2e;
            --text-secondary: #5a5a70;
            --text-tertiary: #8a8a98;
            --input-bg: #f5f7fc;
            --input-bg-hover: #eef1f8;
            --input-border: #d0d4e0;
            --input-border-focus: #4a5aff;
            --link-color: #4a5aff;
            --link-hover: #3648e6;
            --sub-bg-color: rgba(255, 255, 255, 0.1);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --shadow-xl: 0 12px 48px rgba(0, 0, 0, 0.2);
        }

        /* --- Global Styles --- */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-gradient);
            color: var(--text-primary);
            transition: background 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s;
            min-height: 100vh;
            line-height: 1.6;
        }

        @media (max-width: 639px) {
            body {
                padding: 0.75rem;
            }
        }

        .container-card {
            background: var(--card-bg);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--card-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(10px);
        }

        .container-card:hover {
            box-shadow: var(--shadow-xl);
        }

        @media (max-width: 639px) {
            #mainCard {
                padding: 1rem;
            }
        }

        .text-secondary {
            color: var(--text-secondary);
        }

        .text-link {
            color: var(--link-color);
            transition: color 0.2s;
        }

        .text-link:hover {
            color: var(--link-hover);
        }

        .input-style {
            background-color: var(--input-bg);
            border-color: var(--input-border);
            color: var(--text-primary);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .input-style:hover {
            background-color: var(--input-bg-hover);
        }

        .input-style:focus {
            outline: none;
            border-color: var(--input-border-focus);
            box-shadow: 0 0 0 3px rgba(74, 90, 255, 0.1);
        }

        .status-box {
            background-color: var(--card-bg-elevated);
            border: 1px solid var(--card-border);
            color: var(--text-secondary);
            box-shadow: var(--shadow-sm);
        }

        /* ICON STYLING */
        .icon {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: var(--text-primary);
            line-height: 1;
        }

        /* --- Header Styles --- */
        header {
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        header h1 {
            background: linear-gradient(135deg, var(--link-color) 0%, var(--link-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        header p {
            font-weight: 500;
            letter-spacing: 0.01em;
        }

        /* Theme Toggle Button */
        #themeToggle {
            background: var(--card-bg);
            border: 2px solid var(--card-border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        #themeToggle:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: var(--shadow-md);
            border-color: var(--link-color);
        }

        #themeToggle:active {
            transform: scale(0.95);
        }

        /* --- Component Specific Styles --- */
        .media-container {
            position: relative;
            aspect-ratio: 16 / 9;
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            border-radius: 0.75rem;
            overflow: hidden;
            width: 100%;
            box-shadow: var(--shadow-xl);
            border: 2px solid rgba(107, 122, 255, 0.2);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .media-container:hover {
            border-color: rgba(107, 122, 255, 0.4);
            box-shadow: 0 12px 48px rgba(107, 122, 255, 0.2);
        }

        .media-container > * {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
        }

        .file-input-wrapper input[type="file"] {
            opacity: 0;
            position: absolute;
            width: 100%;
            height: 100%;
            cursor: pointer;
            z-index: 20;
        }

        /* Button Styles */
        .btn {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            letter-spacing: 0.02em;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:active {
            transform: scale(0.97);
        }

        /* Primary Button */
        .btn-primary {
            background: linear-gradient(135deg, #3b6eff 0%, #2563eb 100%);
            border-color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.5);
        }

        /* Secondary Button */
        .btn-secondary {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            border-color: #4f46e5;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #4f46e5 0%, #4338ca 100%);
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5);
        }

        /* Tertiary Button */
        .btn-tertiary {
            background: linear-gradient(135deg, #14b8a6 0%, #10b981 100%);
            border-color: #10b981;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .btn-tertiary:hover {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.5);
        }

        /* Label Styles */
        label {
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
        }

        /* Input Field Enhancement */
        input[type="text"] {
            font-size: 0.95rem;
        }

        input[type="text"]::placeholder {
            color: var(--text-tertiary);
            opacity: 0.7;
        }

        /* Slider Styling */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            height: 20px;
        }

        input[type="range"]:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 90, 255, 0.15);
            border-radius: 6px;
        }

        /* Webkit (Chrome, Safari, Edge) */
        input[type="range"]::-webkit-slider-runnable-track {
            height: 6px;
            background: var(--input-border);
            border-radius: 3px;
            border: none;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--link-color) 0%, var(--link-hover) 100%);
            cursor: pointer;
            margin-top: -6px;
            border: 3px solid var(--card-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 12px rgba(107, 122, 255, 0.5);
        }

        /* Mozilla (Firefox) */
        input[type="range"]::-moz-range-track {
            height: 6px;
            background: var(--input-border);
            border-radius: 3px;
            border: none;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        input[type="range"]::-moz-range-thumb {
            height: 18px;
            width: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--link-color) 0%, var(--link-hover) 100%);
            cursor: pointer;
            border: 3px solid var(--card-bg);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 3px 12px rgba(107, 122, 255, 0.5);
        }

        /* Select Dropdown */
        select {
            cursor: pointer;
            font-weight: 500;
        }

        select:hover {
            border-color: var(--input-border-focus);
        }

        /* Color Picker */
        input[type="color"] {
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.2s;
        }

        input[type="color"]:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        /* --- SUBTITLE SETTINGS LAYOUT --- */
        .setting-control {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        #subFontColor, #subFontFamily, #subFontSize, #subOffset, #subBgColor, #subBgOpacity {
            height: 42px;
            padding: 10px 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        #subFontColor, #subBgColor {
            padding: 4px;
            height: 42px;
        }

        /* Settings Panel */
        #subSettingsPanel {
            animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--card-bg);
            margin-top: -1px;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        #subSettingsContent h3 {
            background: linear-gradient(135deg, var(--link-color) 0%, var(--link-hover) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 700;
            letter-spacing: -0.01em;
        }

        /* Alert Box */
        #alertBox {
            animation: slideInDown 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Drag Drop Overlay */
        #dragDropOverlay {
            backdrop-filter: blur(8px);
            animation: fadeIn 0.2s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Footer */
        footer a {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 500;
        }

        footer a:hover {
            background: var(--card-bg);
            box-shadow: var(--shadow-sm);
        }

        /* Responsive Font Sizes */
        @media (max-width: 639px) {
            header h1 {
                font-size: 1.75rem;
            }

            header p {
                font-size: 0.813rem;
            }
        }

        /* Logo Image */
        header img {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        header img:hover {
            transform: rotate(10deg) scale(1.1);
        }

        /* Card Animation */
        #mainCard {
            animation: fadeInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Smooth transitions for mode changes */
        .media-container, .media-container > * {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

    </style>
</head>
<body class="p-4 sm:p-8 min-h-screen">

    <div id="app" class="max-w-5xl mx-auto" role="main">
        <header class="text-center mb-8 sm:mb-12 flex items-center justify-between">
            <div class="flex-grow text-left sm:text-center">
                <div class="inline-flex items-center justify-start sm:justify-center">
                    <img src="/assets/logo.png"
                                 alt="Robust Media Player Logo"
                                 class="h-7 w-7 sm:h-10 sm:w-10 mr-2 sm:mr-3"
                                 aria-hidden="true"
                                 onerror="this.style.display='none'">
                    <h1 class="text-2xl sm:text-4xl font-extrabold text-link">Robust Media Player</h1>
                </div>
                <p class="mt-2 sm:mt-3 text-sm sm:text-base text-secondary">Load direct video/audio files or use external embeds.</p>
            </div>

            <button id="themeToggle"
                    class="w-11 h-11 sm:w-14 sm:h-14 flex items-center justify-center rounded-full shadow-lg hover:shadow-xl transition-all duration-300 flex-shrink-0"
                    aria-label="Toggle Dark/Light Mode"
                    title="Toggle Dark/Light Mode">
                <i id="moonIcon" class="icon fa-solid fa-moon text-xl sm:text-2xl" aria-hidden="true"></i>
                <i id="sunIcon" class="icon fa-solid fa-sun text-xl sm:text-2xl hidden" aria-hidden="true"></i>
            </button>
        </header>

        <div id="mainCard" class="container-card p-5 sm:p-10 rounded-2xl relative">

            <div id="alertBox" class="hidden p-4 rounded-xl text-xs sm:text-sm mb-5 sm:mb-7 shadow-xl flex items-center" role="alert" aria-live="assertive">
                <div class="flex items-center">
                    <svg id="alertIcon" class="w-5 h-5 sm:w-6 sm:h-6 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    <span id="alertText" class="font-medium"></span>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 sm:gap-5 mb-6 sm:mb-8" role="group" aria-labelledby="control-group-label">
                <h2 id="control-group-label" class="sr-only">Media Loading Controls</h2>

                <div class="md:col-span-2">
                    <label for="videoUrl" class="block text-xs sm:text-sm font-medium text-secondary mb-2">Video/Embed URL</label>
                    <div class="flex" role="search">
                        <input type="text" id="videoUrl" placeholder="Enter link, e.g., https://streamtape.com/e/ or direct mp4/mp3 link"
                               class="flex-grow p-3 sm:p-3.5 border-2 rounded-l-xl input-style focus:ring-blue-500 focus:border-blue-500 outline-none"
                               aria-label="Media or Embed URL Input">
                        <button id="loadUrlBtn"
                                class="btn btn-primary px-4 sm:px-6 py-3 sm:py-3.5 text-white rounded-r-xl flex-shrink-0 flex items-center justify-center"
                                aria-label="Load Media or Embed Link">
                            <span class="hidden sm:inline">Load Link</span>
                            <i class="fa-solid fa-arrow-right sm:hidden text-lg"></i>
                        </button>
                    </div>
                </div>

                <div class="file-input-wrapper relative overflow-hidden inline-block w-full">
                    <button class="btn btn-secondary w-full text-white py-3 sm:py-4 rounded-xl shadow-md flex flex-col justify-center items-center"
                            aria-hidden="true" tabindex="-1">
                        <div class="text-sm sm:text-base font-semibold">Load Local Media File</div>
                        <span class="text-[10px] font-thin text-indigo-200 opacity-90 mt-1.5">Video (.mp4, .webm, .mkv, .avi, .mov) & Audio (.mp3, .wav, .flac)</span>
                    </button>
                    <input type="file" id="videoFile" accept="video/*,audio/*" class="absolute inset-0 block"
                            aria-label="Select local video or audio file to load">
                </div>

                <div class="relative w-full">
                    <div class="grid grid-cols-5">
                        <div class="file-input-wrapper relative overflow-hidden inline-block col-span-4">
                            <button class="btn btn-tertiary w-full text-white py-3 sm:py-4 rounded-l-xl shadow-md flex flex-col justify-center items-center h-full"
                                     aria-hidden="true" tabindex="-1">
                                <div class="text-sm sm:text-base font-semibold">Load Local Subtitle</div>
                                <span class="text-[10px] font-thin text-teal-100 opacity-90 mt-1.5">Subtitles (.vtt, .srt)</span>
                            </button>
                            <input type="file" id="subtitleFile" accept=".vtt,.srt" class="absolute inset-0 block"
                                     aria-label="Select local subtitle file (VTT or SRT) to load">
                        </div>
                        <button id="subSettingsToggle"
                                    class="btn btn-tertiary text-white py-3 sm:py-4 rounded-r-xl shadow-md flex items-center justify-center flex-shrink-0"
                                    aria-label="Toggle Subtitle Appearance Settings"
                                    aria-controls="subSettingsPanel"
                                    aria-expanded="false">
                            <i class="fa-solid fa-gear text-lg sm:text-xl" style="color: white; transform: rotate(0deg); transition: transform 0.3s;" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div id="subSettingsPanel" class="mb-6 sm:mb-8 hidden border-2 border-card-border shadow-md rounded-2xl bg-card-bg"
                 role="region" aria-labelledby="sub-settings-heading">
                <div id="subSettingsContent" class="p-4 sm:p-6">
                    <h3 id="sub-settings-heading" class="text-lg sm:text-xl font-semibold text-link mb-4 sm:mb-5">Subtitle Appearance Settings</h3>

                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-4 sm:gap-5 text-xs sm:text-sm">

                        <div class="setting-control">
                            <label for="subFontColor" class="text-secondary">Font Color</label>
                            <input type="color" id="subFontColor" class="w-full border-2 rounded-lg input-style cursor-pointer" value="#ffffff"
                                     aria-label="Subtitle Font Color Picker">
                        </div>

                        <div class="setting-control">
                            <label for="subFontFamily" class="text-secondary">Font Family</label>
                            <select id="subFontFamily" class="w-full border-2 rounded-lg input-style"
                                     aria-label="Subtitle Font Family Selector">
                                <option value="'Inter', sans-serif">Inter (Default)</option>
                                <option value="'Roboto', sans-serif">Roboto (Clean Sans)</option>
                                <option value="'Open Sans', sans-serif">Open Sans (Open, Legible)</option>
                                <option value="'Lato', sans-serif">Lato (High Contrast)</option>
                                <option value="'Montserrat', sans-serif">Montserrat (Modern)</option>
                                <option value="'Source Sans Pro', sans-serif">Source Sans Pro (Geometric)</option>
                                <option value="'PT Serif', serif">PT Serif (Classic Serif)</option>
                                <option value="'Fira Sans', sans-serif">Fira Sans (Accessibility)</option>
                                <option value="'Courier New', monospace">Courier New (Monospace)</option>
                            </select>
                        </div>

                        <div class="setting-control">
                            <label for="subFontSize" class="text-secondary">Font Size (<span id="currentFontSize">24px</span>)</label>
                            <input type="range" id="subFontSize" min="2" max="100" value="24" step="1"
                                     class="w-full cursor-pointer"
                                     aria-label="Subtitle Font Size Slider, minimum 2 pixels, maximum 100 pixels">
                        </div>

                    </div>

                    <div class="setting-control mt-5 border-t-2 border-card-border pt-5">
                        <label for="subOffset" class="text-secondary">Subtitle Offset (Seconds: <span id="currentSubOffset">0.0</span>s)</label>
                        <input type="range" id="subOffset" min="-10" max="10" value="0.0" step="0.1"
                                class="w-full cursor-pointer"
                                aria-label="Subtitle Timing Offset Slider, from -10 to +10 seconds">
                    </div>

                </div>
            </div>


            <div class="media-container rounded-2xl shadow-2xl" role="region" aria-label="Media Player and Subtitle Preview Area">
                <div id="subtitleDemo" class="absolute z-50 bottom-4 sm:bottom-8 left-1/2 transform -translate-x-1/2 p-2 pointer-events-none transition-all duration-300 ease-in-out text-center hidden max-w-full"
                              aria-live="polite" aria-atomic="true">
                    <span id="demoText" style="white-space: nowrap; padding: 6px 12px; border-radius: 6px; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);">The quick brown fox jumps over the lazy dog</span>
                </div>

                <div id="dragDropOverlay" class="absolute inset-0 z-10 hidden flex-col items-center justify-center
                                                 bg-gray-900/90 border-4 border-dashed border-blue-500 rounded-2xl transition duration-150 ease-in-out pointer-events-none"
                                                 aria-hidden="true">
                    <p class="text-2xl sm:text-4xl text-blue-300 font-bold mb-3">Drop File Here</p>
                    <p class="text-base sm:text-xl text-gray-300 font-medium">(Video, Audio, .VTT, or .SRT)</p>
                </div>

                <video id="videoPlayer" controls preload="auto" poster="https://placehold.co/800x450/1f2937/a0aec0?text=Ready+to+Load+Media"
                                 aria-label="HTML5 Video Player for local media">
                    </video>

                <iframe id="iframePlayer" style="display: none;"
                                 allowfullscreen allowtransparency allow="autoplay" scrolling="no" frameborder="0"
                                 aria-label="External Video Embed Player">
                </iframe>
            </div>

            <div id="statusMessage" class="mt-5 sm:mt-6 text-center text-sm sm:text-base p-4 rounded-xl status-box font-medium" role="status" aria-live="polite">
                Ready to load content. Drag and drop a file onto the player area above!
            </div>

        </div>
        <footer id="main-footer" class="mt-12 sm:mt-16 text-center">
            <a href="mailto:arunthomas04042001@gmail.com" class="inline-flex items-center gap-2.5 text-sm sm:text-base text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400">
                <i class="fas fa-envelope text-base sm:text-lg"></i>
                <span>Reach out to the dev</span>
            </a>
        </footer>
    </div>

    <script>
        // Setup Firestore global variables (even if not used, they must be initialized if present)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // --- Core Application Logic ---

        const videoPlayer = document.getElementById('videoPlayer');
        const iframePlayer = document.getElementById('iframePlayer');
        const videoUrlInput = document.getElementById('videoUrl');
        const loadUrlBtn = document.getElementById('loadUrlBtn');
        const videoFileInput = document.getElementById('videoFile');
        const subtitleFileInput = document.getElementById('subtitleFile');
        const statusMessage = document.getElementById('statusMessage');
        const mainCard = document.getElementById('mainCard'); // Main drag target
        const dragDropOverlay = document.getElementById('dragDropOverlay');
        const themeToggle = document.getElementById('themeToggle');

        // Updated to target the new Font Awesome <i> tags
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');

        const subtitleStyleSheet = document.getElementById('subtitle-style');

        // Subtitle customization DOM elements
        const subSettingsToggle = document.getElementById('subSettingsToggle'); // Now the gear button
        const subSettingsPanel = document.getElementById('subSettingsPanel');

        // Demo elements
        const subtitleDemo = document.getElementById('subtitleDemo');
        const demoText = document.getElementById('demoText');

        // Input elements
        const subFontColorInput = document.getElementById('subFontColor');
        const subFontSizeInput = document.getElementById('subFontSize');
        const subFontFamilyInput = document.getElementById('subFontFamily');
        const subOffsetInput = document.getElementById('subOffset');

        // New element to display current size and offset
        const currentFontSizeSpan = document.getElementById('currentFontSize');
        const currentSubOffsetSpan = document.getElementById('currentSubOffset');


        // --- State Management ---
        let alertTimeout;
        let currentVideoBlobUrl = null; // Track the current video's blob URL for revocation

        // Global variable to store the original cues when a subtitle file is loaded
        let originalCues = [];
        let activeTrack = null; // Reference to the currently active TextTrack

        /**
         * Helper function to convert hex color to RGBA format. (NOW UNUSED)
         */
        function hexToRgba(hex, alpha) {
            const shortHex = hex.startsWith('#') ? hex.slice(1) : hex;
            const standardHex = shortHex.length === 3
                ? shortHex.split('').map(char => char + char).join('')
                : shortHex;

            const r = parseInt(standardHex.slice(0, 2), 16);
            const g = parseInt(standardHex.slice(2, 4), 16);
            const b = parseInt(standardHex.slice(4, 6), 16);
            const finalAlpha = Math.max(0, Math.min(1, parseFloat(alpha)));

            return `rgba(${r}, ${g}, ${b}, ${finalAlpha})`;
        }

        // --- Theme Toggle Logic (unchanged) ---

        /**
         * Sets the current theme mode (light or dark).
         * @param {string} theme - 'light' or 'dark'.
         */
        function setTheme(theme) {
            if (theme === 'light') {
                document.body.classList.add('light-mode');
                // Use Font Awesome icons with the same toggling logic
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
                localStorage.setItem('theme', 'light');
            } else {
                document.body.classList.remove('light-mode');
                // Use Font Awesome icons with the same toggling logic
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
                localStorage.setItem('theme', 'dark');
            }
        }

        themeToggle.addEventListener('click', () => {
            if (document.body.classList.contains('light-mode')) {
                setTheme('dark');
            } else {
                setTheme('light');
            }
        });

        // Initialize theme on load
        const storedTheme = localStorage.getItem('theme');
        if (storedTheme) {
            setTheme(storedTheme);
        } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches) {
            // Default to system light preference if no storage exists
            setTheme('light');
        } else {
            setTheme('dark');
        }

        // --- Subtitle Styling and Offset Logic ---

        const SUB_SETTINGS_KEY = 'subtitleSettings';

        /**
         * Loads saved subtitle settings from localStorage and applies them to inputs.
         */
        function loadSubtitleSettings() {
            const savedSettings = localStorage.getItem(SUB_SETTINGS_KEY);
            const defaultSettings = {
                fontColor: '#ffffff',
                fontSize: '24px',
                fontFamily: "'Inter', sans-serif",
                subOffset: 0.0,
            };

            const settings = savedSettings ? JSON.parse(savedSettings) : defaultSettings;

            // Clean up localStorage to remove old, problematic settings
            if (savedSettings && settings.bgColor) {
                delete settings.bgColor;
                delete settings.bgOpacity;
                localStorage.setItem(SUB_SETTINGS_KEY, JSON.stringify(settings));
            }


            // Apply settings to controls
            subFontColorInput.value = settings.fontColor;

            // Set slider values, clamping as needed
            const sizeInPixels = parseInt(settings.fontSize.replace('px', '')) || 24;
            subFontSizeInput.value = Math.max(2, Math.min(100, sizeInPixels));

            subOffsetInput.value = parseFloat(settings.subOffset) || 0.0;

            subFontFamilyInput.value = settings.fontFamily;

            // Apply styles and offset immediately
            applySubtitleStyles();
            applySubtitleOffset();

            // Set initial demo text
            demoText.textContent = "The quick brown fox jumps over the lazy dog";
        }

        /**
         * Reads current input values, saves them, and updates the ::cue CSS rule AND the live demo.
         */
        function applySubtitleStyles() {
            // Read raw value (number string from slider)
            const rawFontSize = subFontSizeInput.value;
            const rawOffset = parseFloat(subOffsetInput.value).toFixed(1);

            // Use transparent background for cue by default (since customization is buggy)
            const cueBgColor = 'transparent';

            const settings = {
                fontColor: subFontColorInput.value,
                fontSize: rawFontSize + 'px',
                fontFamily: subFontFamilyInput.value,
                subOffset: rawOffset,
            };

            // Update the visual display next to the labels
            if(currentFontSizeSpan) {
                currentFontSizeSpan.textContent = settings.fontSize;
            }
            if(currentSubOffsetSpan) {
                currentSubOffsetSpan.textContent = rawOffset;
            }

            // Save to localStorage for persistence
            localStorage.setItem(SUB_SETTINGS_KEY, JSON.stringify(settings));


            // --- 1. Apply to actual ::cue element (via dynamic style tag) ---
            const cssRule = `
                video::cue {
                    color: ${settings.fontColor} !important;
                    /* Force background to transparent to ensure compatibility and remove potential dark boxes */
                    background-color: transparent !important;
                    font-size: ${settings.fontSize} !important;
                    font-family: ${settings.fontFamily} !important;
                    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
                    /* Set padding/border-radius to zero to disable box styling */
                    padding: 0 !important;
                    border-radius: 0 !important;
                }
            `;
            subtitleStyleSheet.textContent = cssRule;

            // --- 2. Apply to LIVE DEMO overlay (uses vw units for proportionality) ---
            // Calculate proportional demo size
            const proportionalSize = (parseInt(rawFontSize) / 100) * 5;
            const demoFontSize = Math.max(0.5, Math.min(6.0, proportionalSize));

            demoText.style.color = settings.fontColor;
            demoText.style.backgroundColor = 'transparent'; // Force transparent for demo too
            demoText.style.fontSize = demoFontSize + 'vw'; /* Use VW for proportional sizing */
            demoText.style.fontFamily = settings.fontFamily;
            demoText.style.textShadow = '2px 2px 4px rgba(0, 0, 0, 0.8)';
            demoText.style.display = 'inline-block';
            demoText.style.padding = '0'; // Remove box padding from demo
            demoText.style.borderRadius = '0'; // Remove box rounding from demo

            // 3. Apply the time offset if a track is active
            applySubtitleOffset();
        }

        /**
         * Applies the time offset to the currently active subtitle track cues.
         */
        function applySubtitleOffset() {
            const offset = parseFloat(subOffsetInput.value);
            currentSubOffsetSpan.textContent = offset.toFixed(1);

            // Find the active track
            const tracks = videoPlayer.textTracks;
            let currentTrack = null;

            for (let i = 0; i < tracks.length; i++) {
                if (tracks[i].mode === 'showing' || tracks[i].default) {
                    currentTrack = tracks[i];
                    break;
                }
            }

            if (!currentTrack) return;

            // If the active track changed, or if cues haven't been stored, store them (only runs once per file load)
            if (currentTrack !== activeTrack || originalCues.length === 0) {
                 // Wait for the track cues to be loaded (can take a moment for large files)
                if (currentTrack.cues && currentTrack.cues.length > 0) {
                    originalCues = Array.from(currentTrack.cues).map(cue => ({
                        start: cue.startTime,
                        end: cue.endTime,
                        text: cue.text
                    }));
                    activeTrack = currentTrack;
                } else {
                    // Try again when cues are ready (e.g., if loaded over network)
                    currentTrack.addEventListener('load', applySubtitleOffset, { once: true });
                    return;
                }
            }

            // Clear existing cues
            while(currentTrack.cues.length > 0) {
                currentTrack.removeCue(currentTrack.cues[0]);
            }

            // Re-add cues with the new offset
            originalCues.forEach(cueData => {
                const newStartTime = Math.max(0, cueData.start + offset);
                const newEndTime = Math.max(newStartTime, cueData.end + offset);

                const newCue = new VTTCue(newStartTime, newEndTime, cueData.text);
                // Inherit alignment properties if available (though many are lost converting to VTT)
                currentTrack.addCue(newCue);
            });

            // This is crucial: the track needs to be showing for the cues to appear
            currentTrack.mode = 'showing';
        }


        // Attach event listeners to all controls for real-time feedback
        [subFontColorInput, subFontFamilyInput, subFontSizeInput, subOffsetInput].forEach(input => {
            // Use 'input' for sliders for smooth drag feedback, 'change' for selects/colors
            const eventType = input.type === 'range' ? 'input' : 'change';
            input.addEventListener(eventType, applySubtitleStyles);
        });

        // --- Collapsible Logic (unchanged) ---

        /**
         * Toggles the visibility of the subtitle settings panel and updates the icon.
         */
        function toggleSubSettings() {
            const isHidden = subSettingsPanel.classList.toggle('hidden');
            const gearIcon = subSettingsToggle.querySelector('i'); // Target the Font Awesome <i> tag

            // FIX 2: Only hide the demo if the panel is closed.
            subtitleDemo.classList.toggle('hidden', isHidden);

            // Update the gear icon rotation (Subtle 180-degree flip)
            gearIcon.style.transform = isHidden ? '' : 'rotate(180deg)';

            // Update ARIA attribute for screen readers
            subSettingsToggle.setAttribute('aria-expanded', !isHidden);
        }

        // Add event listener to the new gear icon toggle
        subSettingsToggle.addEventListener('click', toggleSubSettings);


        // --- Utility Functions (unchanged) ---

        /**
         * Displays a temporary, visually distinct alert message for errors/warnings/successes.
         */
        function showTemporaryAlert(message, type) {
            const alertBox = document.getElementById('alertBox');
            const alertText = document.getElementById('alertText');
            const alertIcon = document.getElementById('alertIcon');

            if (alertTimeout) {
                clearTimeout(alertTimeout);
            }

            // Reset classes
            alertBox.className = "hidden p-4 rounded-xl text-xs sm:text-sm mb-5 sm:mb-7 shadow-xl flex items-center";
            alertIcon.innerHTML = ''; // Clear icon content
            alertBox.classList.remove('bg-red-900', 'text-red-300', 'border-red-700', 'bg-yellow-900', 'text-yellow-300', 'border-yellow-700', 'bg-green-900', 'text-green-300', 'border-green-700');

            if (type === 'error') {
                // Red for critical failure
                alertBox.classList.add('bg-red-900', 'text-red-300', 'border', 'border-red-700');
                // Error icon
                alertIcon.innerHTML = `<path fill-rule="evenodd" d="M8.257 3.376a1.5 1.5 0 012.486 0l5.5 10A1.5 1.5 0 0115 15.75H5a1.5 1.5 0 01-1.243-2.374l5.5-10zM12 9a1 1 0 11-2 0 1 1 0 012 0zm-1 2a1 1 0 10-2 0v2a1 1 0 102 0v-2z" clip-rule="evenodd" />`;
            } else if (type === 'warning') {
                // Yellow/Orange for non-critical warnings
                alertBox.classList.add('bg-yellow-900', 'text-yellow-300', 'border', 'border-yellow-700');
                // Warning icon
                alertIcon.innerHTML = `<path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>`;
            } else if (type === 'success') {
                // Green for success messages
                alertBox.classList.add('bg-green-900', 'text-green-300', 'border', 'border-green-700');
                // Checkmark icon
                alertIcon.innerHTML = `<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.644-1.897-1.898a.75.75 0 10-1.06 1.06l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />`;
            }

            alertText.textContent = message;
            alertBox.classList.remove('hidden');

            alertTimeout = setTimeout(() => {
                alertBox.classList.add('hidden');
            }, 8000);
        }

        /**
         * Clears existing subtitle tracks from the video element and resets state.
         */
        function clearTracks() {
            const tracks = videoPlayer.querySelectorAll('track');
            tracks.forEach(track => {
                if (track.src.startsWith('blob:')) {
                    URL.revokeObjectURL(track.src);
                }
                track.remove();
            });
            originalCues = [];
            activeTrack = null;
        }

        /**
         * Switches the display mode to either HTML5 Video or Iframe Embed.
         * @param {string} mode - 'video' or 'iframe'.
         */
        function setPlayerMode(mode) {
            if (mode === 'video') {
                videoPlayer.style.display = 'block';
                iframePlayer.style.display = 'none';
                iframePlayer.src = '';
                // Enable drag drop overlay only for HTML5 video mode
                dragDropOverlay.classList.remove('pointer-events-none');
            } else if (mode === 'iframe') {
                videoPlayer.style.display = 'none';
                videoPlayer.src = '';
                videoPlayer.poster = 'https://placehold.co/800x450/1f2937/a0aec0?text=External+Embed+Loaded';
                clearTracks();
                iframePlayer.style.display = 'block';
                // Disable drag drop overlay in iframe mode as subs won't work
                dragDropOverlay.classList.add('pointer-events-none');

                // Clear media download state for external embeds
                if (currentVideoBlobUrl) {
                    URL.revokeObjectURL(currentVideoBlobUrl);
                }
                currentVideoBlobUrl = null;
            }
            // Hide the subtitle demo when player mode changes or media is active
            if (subtitleDemo.classList.contains('hidden')) {
                // If it was already hidden (settings closed), keep it hidden
            } else {
                subtitleDemo.classList.add('hidden');
            }
        }

        /**
         * Converts SRT format text to VTT format text.
         */
        function srtToVtt(srtText) {
            // Replace all comma delimiters (used by SRT for milliseconds) with periods (used by VTT)
            const vttBody = srtText.replace(/(\d{2}:\d{2}:\d{2}),(\d{3})/g, '$1.$2');
            return 'WEBVTT\n\n' + vttBody;
        }

        /**
         * Updates the media source and switches between HTML5 Video and Iframe.
         * @param {string} src - The new media source URL.
         * @param {string | null} fileName - The filename if loaded from disk.
         */
        function loadMediaSource(src, fileName = null) {
            src = src ? src.trim() : '';

            // Handle clearing source
            if (!src) {
                if (currentVideoBlobUrl) {
                    URL.revokeObjectURL(currentVideoBlobUrl);
                }
                setPlayerMode('video');
                videoPlayer.src = '';
                videoPlayer.poster = 'https://placehold.co/800x450/1f2937/a0aec0?text=No+Media+Loaded';
                statusMessage.textContent = 'Media source cleared.';
                videoPlayer.load();
                return;
            }

            const isBlobUrl = src.startsWith('blob:');
            const mediaExtensions = /\.(mp4|webm|ogg|mov|avi|m4v|flv|f4v|mkv|wmv|ts|mp3|wav|flac|m4a)$/i;
            const urlWithoutQuery = src.split('?')[0];

            const isDirectMediaFile = mediaExtensions.test(urlWithoutQuery) || isBlobUrl;
            const isExternalLink = src.startsWith('http://') || src.startsWith('https://');

            if (isDirectMediaFile) {
                // Mode 1: HTML5 Video/Audio (Supports Subtitles - local VTT/SRT files via Blob)
                setPlayerMode('video');

                // --- Memory Management: Revoke old Blob URL ---
                if (currentVideoBlobUrl && currentVideoBlobUrl !== src && currentVideoBlobUrl.startsWith('blob:')) {
                    URL.revokeObjectURL(currentVideoBlobUrl);
                }

                // If the new source is a blob URL, track it
                if (isBlobUrl) {
                    currentVideoBlobUrl = src;
                } else {
                    currentVideoBlobUrl = null;
                }

                videoPlayer.removeAttribute('src');
                videoPlayer.src = src;
                videoPlayer.load();

                videoPlayer.poster = '';
                const sourceType = isBlobUrl ? 'Local File (Drag & Drop)' : 'Direct Link';
                const mediaType = src.match(/\.(mp3|wav|flac|m4a)$/i) ? 'Audio' : 'Video';

                statusMessage.textContent = `${sourceType} (${mediaType}) loaded. Local subtitle loading is supported.`;
                showTemporaryAlert(`Successfully switched to HTML5 ${mediaType} Mode. Source Type: ${sourceType}`, 'success');
            } else if (isExternalLink) {
                // Revoke any previous local video URL
                if (currentVideoBlobUrl) {
                    URL.revokeObjectURL(currentVideoBlobUrl);
                }
                currentVideoBlobUrl = null;

                // Mode 2: Iframe Embed (Does NOT support local Subtitles)
                setPlayerMode('iframe');
                iframePlayer.src = src;
                statusMessage.innerHTML = 'External embed loaded via Iframe. <span class="text-red-400 font-bold">Local subtitle loading is NOT supported.</span>';
                showTemporaryAlert('Warning: External embed loaded. Subtitles are unavailable due to cross-domain security.', 'warning');
            } else {
                setPlayerMode('video');
                videoPlayer.src = '';
                videoPlayer.poster = 'https://placehold.co/800x450/cc3333/ffffff?text=Invalid+Input';
                videoPlayer.load();
                statusMessage.textContent = 'Error: Unrecognized link format or insecure protocol.';
                showTemporaryAlert('Error: Unrecognized link format. Please check your URL input.', 'error');
            }
        }

        /**
         * Processes a subtitle file (VTT or SRT) and attaches it to the video player.
         * @param {File} file - The subtitle file object.
         */
        function processSubtitleFile(file) {
             if (videoPlayer.style.display === 'none' || !videoPlayer.src) {
                 showTemporaryAlert('Error: Load a media file in HTML5 Player Mode first.', 'error');
                 subtitleFileInput.value = null;
                 return;
            }

            const fileName = file.name.toLowerCase();
            let mimeType = 'text/vtt';
            let fileType = '';

            if (fileName.endsWith('.vtt')) {
                fileType = 'WebVTT (.vtt)';
            } else if (fileName.endsWith('.srt')) {
                fileType = 'SubRip (.srt)';
            } else {
                showTemporaryAlert('Error: Unsupported subtitle file type. Only .vtt and .srt are accepted.', 'error');
                subtitleFileInput.value = null;
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                let textContent = e.target.result;

                try {
                    if (fileType === 'SubRip (.srt)') {
                        textContent = srtToVtt(textContent);
                        statusMessage.textContent = `Converting ${fileType} to VTT...`;
                    }

                    const subtitleBlob = new Blob([textContent], { type: mimeType });
                    const subtitleUrl = URL.createObjectURL(subtitleBlob);

                    // Clear previous subtitle state
                    clearTracks();

                    const track = document.createElement('track');
                    track.kind = 'subtitles';
                    track.label = `Local Subs (${fileType})`;
                    track.srclang = 'en';
                    track.src = subtitleUrl;
                    track.default = true; // This is crucial for initial activation

                    // Must append to the player *before* trying to read cues, to load the VTT
                    videoPlayer.appendChild(track);

                    // Crucial step: wait for the track to load before attempting offset/cues read
                    track.addEventListener('load', () => {
                        statusMessage.textContent = `Subtitle file "${file.name}" loaded and attached.`;
                        showTemporaryAlert(`Subtitle file "${file.name}" loaded successfully. Use the offset slider to sync.`, 'success');

                        // Set the active track and apply the initial offset
                        activeTrack = track.track;
                        applySubtitleOffset();
                    }, { once: true });

                    track.track.addEventListener('error', () => {
                        statusMessage.textContent = `CRITICAL ERROR: Failed to load subtitle track (check file format validity).`;
                        showTemporaryAlert('CRITICAL ERROR: Subtitle file could not be parsed by the browser.', 'error');
                    });

                } catch (error) {
                    console.error('Subtitle processing error:', error);
                    statusMessage.textContent = `An error occurred while processing the subtitle file.`;
                    showTemporaryAlert('An error occurred while processing the subtitle file.', 'error');
                }
                subtitleFileInput.value = null;
            };
            reader.onerror = (error) => {
                console.error('FileReader error:', error);
                statusMessage.textContent = 'Error reading the subtitle file from the disk.';
                showTemporaryAlert('Error reading the subtitle file from the disk.', 'error');
            };

            reader.readAsText(file);
        }

        // --- Event Listeners and Initialization (unchanged) ---

        // Listener for the "Load URL" button.
        loadUrlBtn.addEventListener('click', () => {
            const url = videoUrlInput.value.trim();
            loadMediaSource(url);
            videoFileInput.value = '';
        });

        // Listener for local video file input.
        videoFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                const fileUrl = URL.createObjectURL(file);
                // Pass the filename for memory management
                loadMediaSource(fileUrl, file.name);
                videoUrlInput.value = '';
            }
        });

        // Listener for local subtitle file input.
        subtitleFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (file) {
                processSubtitleFile(file);
            }
        });

        // Initial setup for the poster image on error/no source
        videoPlayer.addEventListener('error', () => {
            statusMessage.textContent = 'Error loading video source. Check URL or file format.';
            videoPlayer.poster = 'https://placehold.co/800x450/cc3333/ffffff?text=Media+Loading+Failed';
            showTemporaryAlert('Media failed to load. Check URL or file type.', 'error');
        });

        // --- Drag and Drop Logic (unchanged) ---

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            mainCard.addEventListener(eventName, (e) => {
                e.preventDefault();
                e.stopPropagation();
            }, false);
        });

        mainCard.addEventListener('dragenter', (e) => {
            // Check if the event contains files and if we are in HTML5 player mode
            if (videoPlayer.style.display !== 'none' && e.dataTransfer.types.includes('Files')) {
                 dragDropOverlay.style.display = 'flex';
            }
        }, false);

        mainCard.addEventListener('dragleave', (e) => {
            // Only hide if the mouse is leaving the main card completely
            if (!mainCard.contains(e.relatedTarget)) {
                dragDropOverlay.style.display = 'none';
            }
        }, false);

        mainCard.addEventListener('drop', (e) => {
            dragDropOverlay.style.display = 'none';
            const files = e.dataTransfer.files;

            if (files.length === 0) return;

            const file = files[0];
            const fileName = file.name.toLowerCase();

            const isVideo = file.type.startsWith('video/') || fileName.match(/\.(mp4|webm|mkv|avi|mov|ts|wmv)$/i);
            const isAudio = file.type.startsWith('audio/') || fileName.match(/\.(mp3|wav|flac|m4a)$/i);
            const isSubtitle = fileName.endsWith('.vtt') || fileName.endsWith('.srt');

            if (isVideo || isAudio) {
                const fileUrl = URL.createObjectURL(file);
                loadMediaSource(fileUrl, file.name); // Pass filename
                videoUrlInput.value = '';
            } else if (isSubtitle) {
                processSubtitleFile(file);
            } else {
                showTemporaryAlert('Dropped file is neither a supported media nor a subtitle file. Supported: Video, Audio, .vtt, .srt', 'error');
            }
        }, false);

        // Add keyboard shortcut for basic media control (Space to Play/Pause)
        document.addEventListener('keydown', (e) => {
            // Check if the active element is NOT the URL input to prevent accidental playback toggles while typing
            if (e.code === 'Space' && document.activeElement !== videoUrlInput && videoPlayer.style.display !== 'none') {
                e.preventDefault();
                if (videoPlayer.paused) {
                    videoPlayer.play();
                } else {
                    videoPlayer.pause();
                }
            }
        });

        // --- Final Setup (unchanged) ---
        // Initialize subtitle settings and theme on page load
        loadSubtitleSettings();
        setPlayerMode('video');

    </script>
</body>
</html>
